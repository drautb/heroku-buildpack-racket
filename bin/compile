#! /bin/sh
set -e

BUILD_DIR=$1
CACHE_DIR=$2

RACKET_URL="http://mirror.racket-lang.org/installers/6.1.1/racket-6.1.1-src.tgz"
VERSION=3
RACKET_VERSION=6.1.1
RACKET_DIR=$CACHE_DIR/racket

indent() {
  sed -u 's/^/       /'
}

echo "-----> Building Racket Runtime Environment"
touch $CACHE_DIR/version
INSTALLED_VERSION=2
if [ ! $INSTALLED_VERSION -eq $VERSION ]; then
    rm -rvf $CACHE_DIR
    mkdir $CACHE_DIR
    curl -L $RACKET_URL | tar xzv
    mkdir $RACKET_DIR
    cd racket-$RACKET_VERSION/src
    ./configure --prefix=$RACKET_DIR
    make
    make install
    echo $VERSION > $CACHE_DIR/version
fi

echo "-----> Creating racketapp From server.rkt"
cd $BUILD_DIR
$RACKET_DIR/bin/raco exe -o racketapp server.rkt
# $RACKET_DIR/bin/raco distribute run heroku-setup
